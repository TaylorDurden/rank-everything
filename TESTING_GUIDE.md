# 测试指南 - Asset Rating Platform

## 📊 当前进度总结

### ✅ 已完成阶段
- **Phase 1-5**: 全部完成（基础架构、评估引擎、AI分析、认证安全、用户体验）
- **Phase 6**: 全部完成（Deepseek集成、API控制、提示词管理、数据导入、PDF生成、通知系统）

### 🎯 项目状态
**所有核心功能已完成！** 系统已具备生产就绪的基础功能。

---

## 🧪 测试清单

### 1. 基础功能测试

#### 1.1 用户认证
- [ ] **注册新用户**
  - 访问 `/register`
  - 创建新账户
  - 验证自动创建租户

- [ ] **登录功能**
  - 使用注册的账户登录
  - 验证 JWT token 存储
  - 检查租户 ID 是否正确设置

- [ ] **路由保护**
  - 未登录时访问受保护页面应重定向到登录页
  - 登录后可以正常访问所有页面

#### 1.2 资产管理
- [ ] **创建资产**
  - 访问 `/assets` 页面
  - 点击"创建资产"
  - 填写资产信息并保存
  - 验证资产出现在列表中

- [ ] **编辑资产**
  - 编辑现有资产
  - 更新元数据
  - 验证更改保存成功

- [ ] **删除资产**
  - 删除一个资产
  - 验证从列表中移除

#### 1.3 模板管理
- [ ] **创建评估模板**
  - 访问 `/templates` 页面
  - 创建新模板
  - 添加评估维度
  - 设置权重

- [ ] **使用模板**
  - 在评估向导中选择模板
  - 验证维度正确显示

---

### 2. Phase 6 新功能测试 ⭐

#### 2.1 Deepseek AI 集成测试

**前提条件**：确保 `DEEPSEEK_API_KEY` 已配置

- [ ] **AI 分析功能**
  1. 创建一个评估（选择资产和模板）
  2. 在评估详情页点击"Request Full Analysis"
  3. 等待 AI 分析完成
  4. 验证返回了结构化的分析结果：
     - `scores` - 维度评分
     - `rationales` - 评分理由
     - `suggestions` - 改进建议
     - `reportMarkdown` - Markdown 报告

- [ ] **API 使用量统计**
  1. 访问 `GET /ai/usage`（需要认证）
  2. 验证返回了使用量信息：
     ```json
     {
       "daily": 1,
       "monthly": 1,
       "dailyLimit": 50,
       "monthlyLimit": 1000,
       "remainingDaily": 49,
       "remainingMonthly": 999
     }
     ```

- [ ] **缓存机制测试**
  1. 对同一个资产+模板组合运行两次分析
  2. 第二次应该使用缓存（查看日志确认）
  3. 验证两次返回结果相同

- [ ] **限流测试**
  1. 快速发起多次分析请求（超过每日限制）
  2. 超出限制后应返回降级分析（不是错误）
  3. 验证使用量统计正确更新

- [ ] **错误处理测试**
  1. 临时移除或错误配置 `DEEPSEEK_API_KEY`
  2. 运行分析应自动降级到简化分析
  3. 不应抛出错误，应返回降级结果

#### 2.2 提示词版本管理测试

- [ ] **查看系统提示词**
  1. 访问 `GET /prompts`（需要认证）
  2. 应该看到系统提示词（来自 seed）：
     - Website Expert
     - Mobile Growth Expert
     - Product Strategy Advisor
     - Default Expert

- [ ] **创建自定义提示词**
  1. 访问 `POST /prompts`
  2. 创建新提示词：
     ```json
     {
       "name": "My Custom Prompt",
       "content": "你是一位专业的评估专家...",
       "assetType": "website",
       "expertRole": "custom_expert"
     }
     ```
  3. 验证创建成功，版本号为 1

- [ ] **创建新版本**
  1. 使用相同名称创建另一个提示词
  2. 验证版本号自动递增为 2
  3. 验证旧版本被停用，新版本被激活

- [ ] **版本对比**
  1. 访问 `GET /prompts/name/My Custom Prompt/compare?v1=1&v2=2`
  2. 验证返回了两个版本的对比和差异

- [ ] **激活旧版本**
  1. 访问 `PATCH /prompts/:id/activate`（使用版本1的ID）
  2. 验证版本1被激活，版本2被停用

- [ ] **使用自定义提示词**
  1. 创建使用自定义提示词的资产类型
  2. 运行 AI 分析
  3. 验证使用了自定义提示词（检查日志）

#### 2.3 数据导入功能测试

- [ ] **CSV 文件上传**
  1. 准备 CSV 文件（包含 name, description, type 列）
  2. 在评估向导的"Asset"步骤选择"Upload File"
  3. 上传 CSV 文件
  4. 验证资产被创建
  5. 验证数据正确解析

- [ ] **JSON 文件上传**
  1. 准备 JSON 文件：
     ```json
     [
       {
         "name": "Test Asset",
         "description": "Test description",
         "type": "website"
       }
     ]
     ```
  2. 上传 JSON 文件
  3. 验证资产被创建

- [ ] **URL 爬取**
  1. 在评估向导选择"Scrape URL"
  2. 输入一个网站 URL（如 https://example.com）
  3. 点击"Scrape"
  4. 验证：
     - 资产被创建
     - 元数据包含网站信息（title, description, og tags等）
     - 资产类型被正确推断

#### 2.4 PDF 报告生成测试

- [ ] **生成 PDF 报告**
  1. 完成一个评估（状态为 completed）
  2. 在评估详情页点击"Download PDF"
  3. 验证：
     - PDF 文件被下载
     - PDF 包含完整的报告内容
     - 格式正确（标题、评分、建议等）

- [ ] **PDF 内容验证**
  1. 打开下载的 PDF
  2. 验证包含：
     - 资产名称和模板名称
     - 总体评分
     - 维度评分详情
     - 关键发现
     - 改进建议
     - 生成时间

#### 2.5 通知系统测试

**前提条件**：配置 `SLACK_WEBHOOK_URL`（可选）

- [ ] **评估完成通知**
  1. 完成一个评估
  2. 验证：
     - 如果配置了 Slack，应收到通知
     - 通知包含资产名称和报告链接

- [ ] **报告生成通知**
  1. 生成 PDF 报告
  2. 验证收到通知（如果配置了）

---

### 3. 集成测试

#### 3.1 完整评估流程
1. [ ] 创建资产
2. [ ] 创建或选择模板
3. [ ] 创建评估
4. [ ] 运行 AI 分析
5. [ ] 查看报告
6. [ ] 下载 PDF
7. [ ] 验证所有步骤正常工作

#### 3.2 多租户隔离测试
1. [ ] 创建两个不同的租户/用户
2. [ ] 在租户A创建资产
3. [ ] 使用租户B登录
4. [ ] 验证租户B看不到租户A的资产

---

### 4. 性能测试

- [ ] **API 响应时间**
  - 测试主要 API 端点响应时间
  - 目标：< 500ms（95%请求）

- [ ] **缓存性能**
  - 测试缓存命中时的响应时间
  - 应该明显快于直接调用 API

- [ ] **PDF 生成性能**
  - 测试 PDF 生成时间
  - 目标：< 30秒

---

### 5. 错误场景测试

- [ ] **无效输入**
  - 提交空表单
  - 提交无效数据
  - 验证错误处理

- [ ] **网络错误**
  - 模拟 Deepseek API 失败
  - 验证降级机制工作

- [ ] **文件上传错误**
  - 上传超大文件
  - 上传不支持的文件类型
  - 验证错误提示

- [ ] **权限错误**
  - 尝试访问其他租户的资源
  - 验证权限检查

---

## 🔍 API 测试工具

### 使用 Swagger UI
1. 启动后端服务：`pnpm dev --filter api`
2. 访问：http://localhost:3000/api
3. 使用 Swagger UI 测试所有 API 端点

### 使用 Postman/Insomnia
1. 导入 API 端点
2. 配置认证头：
   - `Authorization: Bearer <token>`
   - `x-tenant-id: <tenantId>`
3. 测试各个端点

---

## 📝 测试检查清单

### 核心功能
- [ ] 用户注册和登录
- [ ] 资产管理（CRUD）
- [ ] 模板管理
- [ ] 评估创建和跟踪
- [ ] AI 分析功能
- [ ] 报告生成和查看

### Phase 6 新功能
- [ ] Deepseek API 集成
- [ ] API 使用量控制
- [ ] 缓存机制
- [ ] 提示词版本管理
- [ ] 数据导入（CSV/JSON/URL）
- [ ] PDF 报告生成
- [ ] 通知系统

### 安全和权限
- [ ] JWT 认证
- [ ] 多租户隔离
- [ ] 权限检查
- [ ] 输入验证

---

## 🐛 已知问题和待优化

### 潜在改进点
1. **持久化使用量统计**：当前使用内存存储，重启后丢失
   - 建议：使用 Redis 或数据库存储

2. **邮件服务集成**：当前只有模板，需要集成真实邮件服务
   - 建议：集成 SendGrid 或 Nodemailer

3. **PDF 存储**：当前存储在本地文件系统
   - 建议：集成 S3/OSS 对象存储

4. **前端提示词管理界面**：当前只有后端 API
   - 建议：添加前端管理界面

5. **使用量统计前端展示**：当前只有 API
   - 建议：在设置页面添加使用量展示

---

## 🚀 下一步开发建议

### 高优先级
1. **前端提示词管理界面**
   - 创建 `/prompts` 页面
   - 支持创建、编辑、版本管理
   - 版本对比可视化

2. **使用量统计前端展示**
   - 在设置页面添加使用量卡片
   - 显示每日/每月使用情况
   - 剩余配额提示

3. **持久化使用量统计**
   - 创建使用量记录表
   - 定期同步到数据库

### 中优先级
4. **邮件服务集成**
   - 集成 SendGrid 或 Nodemailer
   - 配置邮件模板

5. **PDF 存储优化**
   - 集成对象存储
   - 实现签名 URL

6. **批量操作**
   - 批量导入资产
   - 批量生成报告

### 低优先级
7. **高级分析功能**
   - 趋势分析
   - 对比分析
   - 基准对比

8. **协作功能**
   - 团队评估
   - 评论和讨论
   - 分享功能

---

## 📞 测试支持

如果遇到问题：
1. 检查环境变量配置
2. 查看后端日志
3. 检查数据库连接
4. 验证 API 密钥配置
5. 查看 Swagger 文档

祝测试顺利！🎉

